import numpy as np
import pandas as pd
import streamlit as st
import joblib 
import streamlit as st
import joblib
import numpy as np
import plotly.express as px
import random

# рзз. ржоржбрзЗрж▓ ржУ рж╕рзНржХрзЗрж▓рж╛рж░ рж▓рзЛржб
model = joblib.load('student_model.pkl')
scaler = joblib.load('student_scaler.pkl')

st.title("ЁЯОУ Student Performance Analyzer")

# рзи. ржЗржиржкрзБржЯ рж╕рзЗржХрж╢ржи
col1, col2 = st.columns(2)
with col1:
    attendance = st.number_input("Attendance %", 0, 100, 80)
    homework = st.number_input("Homework %", 0, 100, 70)
with col2:
    midterm = st.number_input("Midterm Score", 0, 100, 50)
    study_hours = st.number_input("Study Hours per week", 0, 50, 15)

# рзй. ржкрзНрж░рзЗржбрж┐ржХрж╢ржи ржПржмржВ ржнрж┐ржЬрзНржпрзБржпрж╝рж╛рж▓рж╛ржЗржЬрзЗрж╢ржи
if st.button("Analyze Now"):
    # ржбрж╛ржЯрж╛ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ
    feature_names = ['attendance_pct', 'homework_pct', 'midterm_score', 'study_hours_per_week']
    input_data = np.array([[attendance, homework, midterm, study_hours]])
    scaled_data = scaler.transform(input_data)
    
    prediction = model.predict(scaled_data)
    probability = model.predict_proba(scaled_data)
    
    # --- ржЧрж╛ржгрж┐рждрж┐ржХ ржкрзНрж░ржнрж╛ржм ржмрзЗрж░ ржХрж░рж╛ (Feature Importance) ---
    # ржкрзНрж░рждрж┐ржЯрж┐ ржлрж┐ржЪрж╛рж░рзЗрж░ ржУрзЯрзЗржЯ (coef) ржПржмржВ ржЗржЙржЬрж╛рж░рзЗрж░ ржЗржиржкрзБржЯрзЗрж░ ржЧрзБржгржлрж▓
    importance = model.coef_[0]
    
    # ржПржХржЯрж┐ DataFrame ржмрж╛ржирж╛ржирзЛ
    impact_df = pd.DataFrame({
        'Feature': ['Attendance', 'Homework', 'Midterm', 'Study Hours'],
        'Weight': importance
    })
    impact_df = impact_df.sort_values(by='Weight')

    # рзк. рж░рзЗржЬрж╛рж▓рзНржЯ ржжрзЗржЦрж╛ржирзЛ
    pass_chance = probability[0][1] * 100
    fail_chance = 100-pass_chance
    
    if prediction[0] == 1:
        st.success(f"### ржкрзНрж░рзЗржбрж┐ржХрж╢ржи: ржЖржкржирж┐ **ржкрж╛рж╕** ржХрж░ржмрзЗржи! ЁЯОЙ")
        st.write(f"ржкрж╛рж╕ ржХрж░рж╛рж░ рж╕ржорзНржнрж╛ржмржирж╛: **{pass_chance:.2f}%**")
        if pass_chance < 90:
            st.write(f"тЪая╕П рж╕рж╛ржмржзрж╛ржирждрж╛: ржЖржкржирж╛рж░ ржПржЦржирзЛ **ржлрзЗрж▓ ржХрж░рж╛рж░ рж╕ржорзНржнрж╛ржмржирж╛ {fail_chance:.2f}%** рж░рзЯрзЗ ржЧрзЗржЫрзЗред")
            st.write("ржПржЗ рж░рж┐рж╕рзНржХ ржХржорж╛рждрзЗ ржЖржкржирж╛рж░ ржкрзЬрж╛рж╢рзЛржирж╛рж░ ржзрж╛рж░рж╛ржмрж╛рж╣рж┐ржХрждрж╛ ржмржЬрж╛рзЯ рж░рж╛ржЦрзБржиред")
        else:
           st.balloons() # рж╕рзНржХрзНрж░рж┐ржирзЗ ржмрзЗрж▓рзБржи ржЙрзЬржмрзЗ!
           st.write("ржЪржорзОржХрж╛рж░! ржЖржкржирж╛рж░ ржкрзНрж░рж╕рзНрждрзБрждрж┐ ржЕржирзЗржХ ржнрж╛рж▓рзЛред")
        
        st.progress(int(pass_chance)) # ржПржХржЯрж┐ ржкрзНрж░рзЛржЧрзНрж░рзЗрж╕ ржмрж╛рж░ ржжрзЗржЦрж╛ржмрзЗ
    else:
        st.error(f"### ржкрзНрж░рзЗржбрж┐ржХрж╢ржи: ржЖржкржирж┐ **ржлрзЗрж▓** ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред тЪая╕П")
        target_goal = random.randint(80, 95)
        st.write(f"ржлрзЗрж▓ ржХрж░рж╛рж░ рж╕ржорзНржнрж╛ржмржирж╛ {fail_chance:.2f}%**")
        st.write(f"ЁЯТб рж╣рждрж╛рж╢ рж╣ржмрзЗржи ржирж╛! ржПржХржЯрзБ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж▓рзЗ ржЖржкржирж╛рж░ ржкрж╛рж╕ ржХрж░рж╛рж░ рж╕ржорзНржнрж╛ржмржирж╛ ржмрж░рзНрждржорж╛ржи {pass_chance:.2f}% ржерзЗржХрзЗ **{target_goal}% ржПрж░ ржЙржкрж░рзЗ** ржЙржирзНржирзАржд ржХрж░рж╛ рж╕ржорзНржнржмред")
        st.progress(int(pass_chance))
    
    # рзм. ржлрзЗрж▓ ржХрж░рж▓рзЗ ржмрж╛ ржкрж╛рж╕рзЗрж░ рж╕ржорзНржнрж╛ржмржирж╛ ржХржо рж╣рж▓рзЗ ржЙржкржжрзЗрж╢ (Recommendations)
    st.markdown("---")
    st.subheader("ЁЯТб ржЙржирзНржирждрж┐рж░ ржЬржирзНржп ржкрж░рж╛ржорж░рзНрж╢ (Recommendations)")

    if prediction[0] == 0: # ржпржжрж┐ ржлрзЗрж▓ ржХрж░рж╛рж░ рж╕ржорзНржнрж╛ржмржирж╛ ржерж╛ржХрзЗ
        st.warning("ржЖржкржирж╛рж░ рж░рзЗржЬрж╛рж▓рзНржЯ ржЖрж╢ржЩрзНржХрж╛ржЬржиржХред ржкрж╛рж╕ ржХрж░рждрзЗ ржирж┐ржЪрзЗрж░ ржмрж┐рж╖рзЯржЧрзБрж▓рзЛрждрзЗ ржиржЬрж░ ржжрж┐ржи:")
        
        # рж╕ржмржЪрзЗрзЯрзЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рзйржЯрж┐ ржлрж┐ржЪрж╛рж░ ржЦрзБржБржЬрзЗ ржмрзЗрж░ ржХрж░рж╛ ржпрж╛рж░ ржУрзЯрзЗржЯ ржмрзЗрж╢рж┐
        # ржЖржорж░рж╛ ржжрзЗржЦржм ржЗржЙржЬрж╛рж░рзЗрж░ ржХрзЛржи ржорж╛ржиржЧрзБрж▓рзЛ ржЧрзЬ (Average) ржерзЗржХрзЗ ржХржо
        if study_hours < 15:
            st.write("ЁЯСЙ **ржкрзЬрж╛рж░ рж╕ржорзЯ ржмрж╛рзЬрж╛ржи:** ржЖржкржирж╛рж░ ржкрзЬрж╛рж░ рж╕ржорзЯ рж╕ржкрзНрждрж╛рж╣рзЗ ржЕржирзНрждржд рззрзл ржШржгрзНржЯрж╛ рж╣ржУрзЯрж╛ ржЙржЪрж┐рждред")
        
        if attendance < 80:
            st.write("ЁЯСЙ **ржЙржкрж╕рзНржерж┐рждрж┐ ржмрж╛рзЬрж╛ржи:** ржХрзНрж▓рж╛рж╕рзЗ ржЕржирзНрждржд рзорзж% ржЙржкрж╕рзНржерж┐рждрж┐ ржкрж╛рж╕рзЗрж░ рж╕ржорзНржнрж╛ржмржирж╛ ржЕржирзЗржХ ржмрж╛рзЬрж┐рзЯрзЗ ржжрзЗрзЯред")
            
        if homework < 70:
            st.write("ЁЯСЙ **рж╣рзЛржоржУрзЯрж╛рж░рзНржХ ржЬржорж╛ ржжрж┐ржи:** ржирж┐рзЯржорж┐ржд рж╣рзЛржоржУрзЯрж╛рж░рзНржХ ржХрж░рж▓рзЗ ржорж┐ржбржЯрж╛рж░рзНржорзЗрж░ ржШрж╛ржЯрждрж┐ ржкрзБрж╖рж┐рзЯрзЗ ржирзЗржУрзЯрж╛ рж╕ржорзНржнржмред")
            
        if midterm < 50:
            st.write("ЁЯСЙ **ржорж┐ржбржЯрж╛рж░рзНржо рж░рж┐ржнрж┐ржЙ:** ржЖржкржирж╛рж░ ржорж┐ржбржЯрж╛рж░рзНржорзЗрж░ рж░рзЗржЬрж╛рж▓рзНржЯ ржжрзБрж░рзНржмрж▓ред ржлрж╛ржЗржирж╛рж▓рзЗрж░ ржЖржЧрзЗ ржПржЗ ржЯржкрж┐ржХржЧрзБрж▓рзЛ ржЖржмрж╛рж░ ржкрзЬрзБржиред")
            
    else: # ржпржжрж┐ ржкрж╛рж╕ ржХрж░рзЗ
        st.success("ржЕржнрж┐ржиржирзНржжржи! ржЖржкржирж┐ рж╕ржарж┐ржХ ржкржерзЗржЗ ржЖржЫрзЗржиред")
        st.write("ржкржЬрж┐рж╢ржи ржЖрж░ржУ ржнрж╛рж▓рзЛ ржХрж░рждрзЗ ржЖржкржирж╛рж░ **Study Hours** ржПржмржВ **Homework** ржПрж░ ржзрж╛рж░рж╛ржмрж╛рж╣рж┐ржХрждрж╛ ржмржЬрж╛рзЯ рж░рж╛ржЦрзБржиред")    
    
    # рзл. ржЧрзНрж░рж╛ржл ржжрзЗржЦрж╛ржирзЛ (ржХрзЗржи ржПржЗ рж░рзЗржЬрж╛рж▓рзНржЯ ржЖрж╕рж▓рзЛ?)
    st.subheader("ЁЯУК ржХрзЗржи ржПржЗ ржлрж▓рж╛ржлрж▓? (Model's Logic)")
    st.write("ржирж┐ржЪрзЗрж░ ржЪрж╛рж░рзНржЯржЯрж┐ ржжрзЗржЦрж╛ржЪрзНржЫрзЗ ржХрзЛржи ржмрж┐рж╖рзЯржЯрж┐ ржкрж╛рж╕рзЗрж░ ржХрзНрж╖рзЗрждрзНрж░рзЗ рж╕ржмржЪрзЗрзЯрзЗ ржмрзЗрж╢рж┐ ржнрзВржорж┐ржХрж╛ рж░рж╛ржЦрзЗ:")
    
    fig = px.bar(impact_df, x='Weight', y='Feature', orientation='h',
                 color='Weight', color_continuous_scale='RdYlGn',
                 labels={'Weight': 'ржкрзНрж░ржнрж╛ржмрзЗрж░ ржорж╛рждрзНрж░рж╛ (Positive = ржкрж╛рж╕рзЗрж░ ржкржХрзНрж╖рзЗ)'})
    
    st.plotly_chart(fig)
